<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Phi·∫øu h·ªçc t·∫≠p s·ªë - To√°n h·ªçc & T√†i ch√≠nh (Online)</title>
<style>
  body { font-family: system-ui, -apple-system, Arial, sans-serif; margin: 0; background: #f5f7fb; }
  header { background: #0f3d68; color: #fff; padding: 16px; }
  main { max-width: 1100px; margin: 0 auto; padding: 16px; }
  .card { background: #fff; border-radius: 10px; padding: 16px; margin-bottom: 16px; box-shadow: 0 2px 8px rgba(0,0,0,.08); }
  h2 { margin-top: 0; font-size: 1.25rem; color: #0f3d68; }
  .row { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 10px; margin-bottom: 10px; }
  label { font-weight: 600; font-size: 0.9rem; display: block; margin-bottom: 4px; }
  input, textarea { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
  button { padding: 10px 16px; border: none; border-radius: 6px; background: #0f3d68; color: #fff; cursor: pointer; font-weight: 600; transition: 0.2s; }
  button:hover { opacity: 0.9; }
  button:disabled { background: #ccc; cursor: not-allowed; }
  button.secondary { background: #6c7aa1; }
  button.warn { background: #b13a3a; }
  .result { margin-top: 10px; padding: 12px; background: #eef3fb; border-radius: 8px; border-left: 4px solid #0f3d68; }
  .hidden { display: none !important; }
  footer { text-align: center; color: #666; padding: 12px; font-size: 0.8rem; margin-top: 20px; }
  .tabs { display: flex; gap: 8px; margin-bottom: 16px; flex-wrap: wrap; }
  .tab { padding: 8px 16px; border-radius: 999px; background: #e5ebf7; cursor: pointer; font-weight: 500; transition: 0.2s; }
  .tab.active { background: #0f3d68; color: #fff; }
  table { width: 100%; border-collapse: collapse; margin-top: 8px; font-size: 0.9rem; }
  th, td { border: 1px solid #dfe6f3; padding: 8px; text-align: right; }
  th { background: #f0f4fb; text-align: center; font-weight: 600; }
  .note { font-size: 0.85rem; color: #666; margin-top: 4px; font-style: italic; }
  .pill { display:inline-block; padding:4px 10px; border-radius:999px; background:#e5ebf7; margin-right:6px; margin-bottom: 6px; font-size: 0.9rem; }
  .level-green { color: #15803d; font-weight: bold; }
  .level-yellow { color: #b45309; font-weight: bold; }
  .level-red { color: #b91c1c; font-weight: bold; }
  #pieChart { max-width: 300px; margin: 10px auto; display: block; }
  
  /* Loading Overlay */
  #loading { position: fixed; top:0; left:0; right:0; bottom:0; background: rgba(255,255,255,0.8); display: flex; align-items: center; justify-content: center; z-index: 999; flex-direction: column; }
  .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #0f3d68; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin-bottom: 10px;}
  @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
</style>
</head>
<body>

<div id="loading" class="hidden">
  <div class="spinner"></div>
  <div id="loadingText">ƒêang x·ª≠ l√Ω...</div>
</div>

<header>
  <h1>Phi·∫øu h·ªçc t·∫≠p s·ªë - To√°n h·ªçc & T√†i ch√≠nh</h1>
  <p>THPT NGUY·ªÑN TH√ÅI B√åNH - T·ªî TO√ÅN (Online Version)</p>
</header>

<main>
  <!-- CONFIG ALERT -->
  <div id="config-alert" style="background: #fff3cd; color: #856404; padding: 10px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #ffeeba;">
    ‚ö†Ô∏è <b>L∆∞u √Ω cho Gi√°o vi√™n:</b> H√£y m·ªü file HTML n√†y b·∫±ng Notepad/Code Editor v√† d√°n link Google Apps Script v√†o bi·∫øn <code>API_URL</code> ·ªü d√≤ng code cu·ªëi c√πng ƒë·ªÉ k√≠ch ho·∫°t t√≠nh nƒÉng N·ªôp b√†i Online.
  </div>

  <div class="tabs">
    <div class="tab active" onclick="showTab('k10', event)">Kh·ªëi 10</div>
    <div class="tab" onclick="showTab('k11', event)">Kh·ªëi 11</div>
    <div class="tab" onclick="showTab('teacher', event)">Dashboard Gi√°o vi√™n</div>
  </div>

  <!-- KH·ªêI 10 -->
  <section id="k10">
    <div class="card">
      <h2>1) Ph√¢n b·ªï ti·ªÅn c√° nh√¢n (Quy t·∫Øc 6 chi·∫øc l·ªç / 50-30-20)</h2>
      <div class="row">
        <div><label>H·ªç v√† t√™n:</label><input id="name10" placeholder="VD: Nguy·ªÖn VƒÉn A"/></div> 
        <div><label>L·ªõp:</label><input id="class10" placeholder="VD: 10C1"/></div>
      </div>
      <div class="row">
        <div><label>T·ªïng thu nh·∫≠p/ti·ªÅn ti√™u v·∫∑t (ƒë)</label><input id="t10_total" type="number" /></div>
        <div><label>Chi thi·∫øt y·∫øu (ƒÉn u·ªëng, ƒëi l·∫°i) (ƒë)</label><input id="t10_study" type="number" /></div>
        <div><label>Chi h∆∞·ªüng th·ª•/S·ªü th√≠ch (ƒë)</label><input id="t10_fun" type="number" /></div>
        <div><label>Ti·∫øt ki·ªám/ƒê·∫ßu t∆∞ (ƒë)</label><input id="t10_save" type="number" /></div>
      </div>
      <button onclick="calcPercent()">T√≠nh to√°n & N·ªòP B√ÄI</button>
      <div id="t10_result" class="result hidden"></div>
    </div>

    <div class="card">
      <h2>2) C√¥ng c·ª• t√≠nh: Ti·∫øt ki·ªám g·ª≠i g√≥p (c·ªông d·ªìn)</h2>
      <div class="row">
        <div><label>S·ªë ti·ªÅn ban ƒë·∫ßu (ƒë)</label><input id="t10_init" type="number" /></div>
        <div><label>M·ªói th√°ng th√™m v√†o (ƒë)</label><input id="t10_add" type="number" /></div>
        <div><label>S·ªë th√°ng d·ª± ki·∫øn</label><input id="t10_months" type="number" /></div>
      </div>
      <button class="secondary" onclick="calcSaving()">Xem b·∫£ng d√≤ng ti·ªÅn</button>
      <div id="t10_table" class="result hidden"></div>
    </div>
  </section>

  <!-- KH·ªêI 11 -->
  <section id="k11" class="hidden">
    <div class="card">
      <h2>3) G·ª≠i ti·ªÅn ng√¢n h√†ng (C√¥ng th·ª©c L√£i k√©p)</h2>
      <div class="row">
        <div><label>H·ªç v√† t√™n:</label><input id="name11" placeholder="VD: Tr·∫ßn Th·ªã B"/></div>
        <div><label>L·ªõp:</label><input id="class11" placeholder="VD: 11B4"/></div>
      </div>
      <div class="row">
        <div><label>P ‚Äì S·ªë ti·ªÅn g·ª≠i ban ƒë·∫ßu (ƒë)</label><input id="k11_p" type="number" /></div>
        <div><label>r ‚Äì L√£i su·∫•t nƒÉm (%)</label><input id="k11_r" type="number" /></div>
        <div><label>n ‚Äì S·ªë nƒÉm g·ª≠i</label><input id="k11_n" type="number" /></div>
      </div>
      <button onclick="calcCompound()">T√≠nh l√£i k√©p & N·ªòP B√ÄI</button>
      <div id="k11_result" class="result hidden"></div>
    </div>

    <div class="card">
      <h2>4) So s√°nh tr·ª±c quan: L√£i ƒë∆°n vs L√£i k√©p</h2>
      <div class="row">
        <div><label>P (ƒë)</label><input id="k11_p2" type="number" /></div>
        <div><label>r (%/nƒÉm)</label><input id="k11_r2" type="number" /></div>
        <div><label>n (nƒÉm)</label><input id="k11_n2" type="number" /></div>
      </div>
      <button class="secondary" onclick="compareInterest()">T·∫°o b·∫£ng so s√°nh</button>
      <div id="k11_table" class="result hidden"></div>
    </div>
  </section>

  <!-- DASHBOARD GI√ÅO VI√äN -->
  <section id="teacher" class="hidden">
    <div class="card">
      <div style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap;">
        <h2>Dashboard t·ªïng h·ª£p (Online)</h2>
        <button onclick="refreshDashboard()" class="secondary" style="font-size:0.9rem;">üîÑ C·∫≠p nh·∫≠t d·ªØ li·ªáu t·ª´ Google Sheet</button>
      </div>
      <p class="note">D·ªØ li·ªáu ƒë∆∞·ª£c t·∫£i tr·ª±c ti·∫øp t·ª´ Google Sheet c·ªßa gi√°o vi√™n.</p>
      
      <div class="row" style="margin-top:15px">
        <div class="pill">T·ªïng b√†i n·ªôp K10: <b id="cnt10">...</b></div>
        <div class="pill">T·ªïng b√†i n·ªôp K11: <b id="cnt11">...</b></div>
        <div class="pill">T·ªâ l·ªá ti·∫øt ki·ªám TB (K10): <b id="avgSave10">...</b></div>
        <div class="pill">V·ªën g·ª≠i TB (K11): <b id="avgP11">...</b></div>
      </div>

      <div id="analysis" class="result" style="margin-top:10px;">ƒêang t·∫£i d·ªØ li·ªáu...</div>
      
      <canvas id="pieChart" width="300" height="300"></canvas>
      
      <div id="ranking" class="result" style="margin-top:10px;"></div>
      
      <div class="row" style="margin-top:10px">
        <a id="linkSheet" href="#" target="_blank" style="text-decoration:none">
          <button style="background:#107c41;">M·ªü Google Sheet g·ªëc</button>
        </a>
      </div>
      
      <h3>Chi ti·∫øt 20 b√†i n·ªôp g·∫ßn nh·∫•t</h3>
      <div id="teacher_table" class="result"></div>
    </div>
  </section>

</main>

<footer>
  ¬© H·ªá th·ªëng To√°n T√†i Ch√≠nh Online.<br>
  Y√™u c·∫ßu k·∫øt n·ªëi Internet ƒë·ªÉ n·ªôp b√†i v√† xem th·ªëng k√™.
</footer>

<script>
// ==========================================================
// C·∫§U H√åNH K·∫æT N·ªêI GOOGLE SHEET
// H√£y thay th·∫ø link b√™n d∆∞·ªõi b·∫±ng link Web App c·ªßa b·∫°n
// L∆ØU √ù: Link ph·∫£i k·∫øt th√∫c b·∫±ng ch·ªØ "/exec", KH√îNG PH·∫¢I "/edit"
const API_URL = "https://script.google.com/macros/s/AKfycbz3QbgYS4t45AzOKUSl9Qqk_HeYCHMeFojL8DqEgLt3NITfLlnu4sLFgS6M3Xy6bB72/exec";
// ==========================================================

// Ki·ªÉm tra xem ng∆∞·ªùi d√πng ƒë√£ d√°n link ch∆∞a
if(API_URL.includes("D√ÅN_LINK") || !API_URL.endsWith("/exec")) {
  document.getElementById('config-alert').style.display = 'block';
  // N·∫øu d√°n sai link edit, hi·ªÉn th·ªã c·∫£nh b√°o c·ª• th·ªÉ
  if(API_URL.includes("/edit")) {
      document.getElementById('config-alert').innerHTML = "‚ö†Ô∏è <b>L·ªñI LINK:</b> B·∫°n ƒëang d√°n link tr√¨nh s·ª≠a code (ƒëu√¥i /edit).<br>H√£y v√†o Deploy > L·∫•y link Web App (ƒëu√¥i /exec).";
  }
} else {
  document.getElementById('config-alert').style.display = 'none';
}

function showLoading(show, text="ƒêang x·ª≠ l√Ω...") {
  const el = document.getElementById('loading');
  document.getElementById('loadingText').innerText = text;
  if(show) el.classList.remove('hidden');
  else el.classList.add('hidden');
}

function showTab(id, ev){
  document.querySelectorAll('section').forEach(s => s.classList.add('hidden'));
  document.getElementById(id).classList.remove('hidden');
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
  if(ev) ev.target.classList.add('active');
  if(id==='teacher') refreshDashboard();
}

function fmt(n){ return Number(n||0).toLocaleString('vi-VN'); }

// H√ÄM G·ª¨I D·ªÆ LI·ªÜU ƒêI (POST)
async function sendData(data) {
  if(API_URL.includes("HAY_DAN_LINK")) {
    alert("L·ªói: Gi√°o vi√™n ch∆∞a c·∫•u h√¨nh ƒë∆∞·ªùng d·∫´n Server (API_URL).");
    return false;
  }
  
  showLoading(true, "ƒêang n·ªôp b√†i l√™n h·ªá th·ªëng...");
  try {
    // S·ª≠ d·ª•ng no-cors ho·∫∑c text/plain payload ƒë·ªÉ tr√°nh l·ªói CORS v·ªõi Google Apps Script
    const response = await fetch(API_URL, {
      method: "POST",
      mode: "no-cors", 
      headers: { "Content-Type": "text/plain" },
      body: JSON.stringify(data)
    });
    // V√¨ mode no-cors, ta kh√¥ng ƒë·ªçc ƒë∆∞·ª£c response JSON, nh∆∞ng gi·∫£ ƒë·ªãnh th√†nh c√¥ng n·∫øu kh√¥ng vƒÉng l·ªói m·∫°ng
    return true;
  } catch (error) {
    console.error(error);
    alert("C√≥ l·ªói khi k·∫øt n·ªëi server: " + error.message);
    return false;
  } finally {
    showLoading(false);
  }
}

// H√ÄM T√çNH TO√ÅN V√Ä G·ª¨I KH·ªêI 10
async function calcPercent(){
  const hoTen = document.getElementById('name10').value.trim();
  const lop = document.getElementById('class10').value.trim();
  const total = +document.getElementById('t10_total').value;
  const study = +document.getElementById('t10_study').value;
  const fun = +document.getElementById('t10_fun').value;
  const save = +document.getElementById('t10_save').value;

  if(!hoTen || !lop) { alert('Vui l√≤ng nh·∫≠p H·ªç t√™n v√† L·ªõp.'); return; }
  if(!total){ alert('Vui l√≤ng nh·∫≠p t·ªïng ti·ªÅn.'); return; }

  const sum = study + fun + save;
  const pStudy = (study/total*100)||0, pFun=(fun/total*100)||0, pSave=(save/total*100)||0;
  
  let level = 'red';
  if(pSave >= 30) level = 'green';
  else if(pSave >= 15) level = 'yellow';

  // Chu·∫©n b·ªã d·ªØ li·ªáu g·ª≠i
  const payload = {
    khoi: 10, hoTen, lop,
    val1: total, val2: study, val3: fun, val4: save,
    level: level
  };

  const success = await sendData(payload);
  
  if(success) {
    let msg = `<b>‚úÖ ƒê√£ n·ªôp b√†i th√†nh c√¥ng!</b><br>
    H·ªçc t·∫≠p: ${pStudy.toFixed(1)}%<br>
    Gi·∫£i tr√≠: ${pFun.toFixed(1)}%<br>
    Ti·∫øt ki·ªám: ${pSave.toFixed(1)}% <span class="level-${level}">(${level === 'green' ? 'T·ªët' : level === 'yellow' ? 'Kh√°' : 'C·∫ßn c·∫£i thi·ªán'})</span>`;
    
    if(Math.abs(sum - total) > 1000){ // Cho ph√©p sai s·ªë nh·ªè
      msg += `<br><span style="color:red; font-size:0.9rem">‚ö†Ô∏è T·ªïng chi (${fmt(sum)}ƒë) ‚â† T·ªïng thu (${fmt(total)}ƒë). H√£y ki·ªÉm tra l·∫°i.</span>`;
    }
    const box = document.getElementById('t10_result');
    box.innerHTML = msg; box.classList.remove('hidden');
  }
}

// H√ÄM T√çNH TO√ÅN V√Ä G·ª¨I KH·ªêI 11
async function calcCompound(){
  const hoTen = document.getElementById('name11').value.trim();
  const lop = document.getElementById('class11').value.trim();
  const P = +document.getElementById('k11_p').value;
  const rVal = +document.getElementById('k11_r').value;
  const r = rVal/100;
  const n = +document.getElementById('k11_n').value;

  if(!hoTen || !lop) { alert('Vui l√≤ng nh·∫≠p H·ªç t√™n v√† L·ªõp.'); return; }
  if(P<=0 || n<=0){ alert('Vui l√≤ng nh·∫≠p P, n h·ª£p l·ªá'); return; }

  // Chu·∫©n b·ªã d·ªØ li·ªáu g·ª≠i
  const payload = {
    khoi: 11, hoTen, lop,
    val1: P, val2: rVal, val3: n, val4: 0, level: ''
  };

  const success = await sendData(payload);

  if(success) {
    let html = `<b>‚úÖ ƒê√£ n·ªôp b√†i! K·∫øt qu·∫£ l√£i k√©p:</b><br><table><tr><th>NƒÉm</th><th>S·ªë ti·ªÅn (ƒë)</th></tr>`;
    for(let i=1;i<=n;i++){
      const S = P*Math.pow(1+r, i);
      html += `<tr><td style="text-align:center">${i}</td><td>${fmt(Math.round(S))}</td></tr>`;
    }
    html += `</table>`;
    const box = document.getElementById('k11_result');
    box.innerHTML = html; box.classList.remove('hidden');
  }
}

// T√çNH TO√ÅN OFFLINE (C√îNG C·ª§ PH·ª§)
function calcSaving(){
  const init = +document.getElementById('t10_init').value;
  const add = +document.getElementById('t10_add').value;
  const months = +document.getElementById('t10_months').value;
  if(months <= 0){ alert('S·ªë th√°ng ph·∫£i > 0'); return; }
  let html = `<table><tr><th>Th√°ng</th><th>S·ªë ti·ªÅn (ƒë)</th></tr>`;
  let total = init;
  for(let i=1;i<=months;i++){
    if(i>1) total += add;
    html += `<tr><td style="text-align:center">${i}</td><td>${fmt(total)}</td></tr>`;
  }
  html += `</table>`;
  document.getElementById('t10_table').innerHTML = html; 
  document.getElementById('t10_table').classList.remove('hidden');
}

function compareInterest(){
  const P = +document.getElementById('k11_p2').value;
  const r = +document.getElementById('k11_r2').value/100;
  const n = +document.getElementById('k11_n2').value;
  if(P<=0 || n<=0){ alert('Vui l√≤ng nh·∫≠p s·ªë li·ªáu h·ª£p l·ªá'); return; }
  let html = `<table><tr><th>NƒÉm</th><th>L√£i ƒë∆°n (ƒë)</th><th>L√£i k√©p (ƒë)</th></tr>`;
  for(let i=1;i<=n;i++){
    const simple = P*(1 + r*i);
    const comp = P*Math.pow(1+r, i);
    html += `<tr><td style="text-align:center">${i}</td><td>${fmt(Math.round(simple))}</td><td>${fmt(Math.round(comp))}</td></tr>`;
  }
  html += `</table>`;
  document.getElementById('k11_table').innerHTML = html;
  document.getElementById('k11_table').classList.remove('hidden');
}

// ==========================================
// PH·∫¶N DASHBOARD GI√ÅO VI√äN (LOAD T·ª™ SHEET)
// ==========================================

async function refreshDashboard(){
  if(API_URL.includes("HAY_DAN_LINK")) {
    document.getElementById('analysis').innerText = "Ch∆∞a c·∫•u h√¨nh API URL.";
    return;
  }

  showLoading(true, "ƒêang t·∫£i d·ªØ li·ªáu t·ª´ Google Sheet...");
  try {
    const res = await fetch(API_URL); // M·∫∑c ƒë·ªãnh l√† GET
    const data = await res.json();
    
    processData(data);
  } catch (e) {
    document.getElementById('analysis').innerHTML = `<span style='color:red'>L·ªói t·∫£i d·ªØ li·ªáu: ${e.message}. H√£y ki·ªÉm tra ƒë∆∞·ªùng truy·ªÅn ho·∫∑c quy·ªÅn truy c·∫≠p Script.</span>`;
  } finally {
    showLoading(false);
  }
}

function processData(rawData) {
  // rawData: [{ts, khoi, sid, val1...}, ...]
  // T√°ch d·ªØ li·ªáu
  const a10 = rawData.filter(x => x.khoi == 10).map(x => ({
    ...x,
    total: x.val1, study: x.val2, fun: x.val3, save: x.val4,
    pSave: (x.val4 / x.val1 * 100) || 0
  }));
  
  const a11 = rawData.filter(x => x.khoi == 11).map(x => ({
    ...x,
    P: x.val1, r: x.val2, n: x.val3
  }));

  // Update ch·ªâ s·ªë
  document.getElementById('cnt10').innerText = a10.length;
  document.getElementById('cnt11').innerText = a11.length;
  
  const avgSave10 = a10.length ? (a10.reduce((s,x)=>s+(x.pSave||0),0)/a10.length).toFixed(1) : 0;
  document.getElementById('avgSave10').innerText = avgSave10 + '%';
  
  const avgP11 = a11.length ? Math.round(a11.reduce((s,x)=>s+(+x.P||0),0)/a11.length) : 0;
  document.getElementById('avgP11').innerText = fmt(avgP11) + ' ƒë';

  // Ph√¢n t√≠ch m·ª©c ƒë·ªô (Green/Yellow/Red)
  let green = 0, yellow = 0, red = 0;
  a10.forEach(x => {
    if (x.level === 'green') green++;
    else if (x.level === 'yellow') yellow++;
    else if (x.level === 'red') red++;
  });

  // V·∫Ω bi·ªÉu ƒë·ªì
  drawPieChart(green, yellow, red);

  // Text ph√¢n t√≠ch
  let analysis = `<b>Ph√¢n t√≠ch ti·∫øt ki·ªám kh·ªëi 10:</b><br>
  - M·ª©c T·ªët (xanh): ${green} HS<br>
  - M·ª©c Kh√° (v√†ng): ${yellow} HS<br>
  - C·∫ßn c·∫£i thi·ªán (ƒë·ªè): ${red} HS<br><br>`;
  
  if (red > green + yellow) analysis += '‚ö†Ô∏è C·∫£nh b√°o: ƒêa s·ªë h·ªçc sinh ch∆∞a c√≥ th√≥i quen ti·∫øt ki·ªám t·ªët.';
  else analysis += '‚úÖ ƒê√°nh gi√° chung: T√¨nh h√¨nh t√†i ch√≠nh c·ªßa l·ªõp kh√° t√≠ch c·ª±c.';
  
  document.getElementById('analysis').innerHTML = analysis;

  // X·∫øp h·∫°ng (Top ti·∫øt ki·ªám)
  const sortedA10 = a10.slice().sort((a,b) => b.pSave - a.pSave);
  let rankingHtml = `<b>üèÜ Top 3 HS Ti·∫øt ki·ªám hi·ªáu qu·∫£ nh·∫•t:</b><br><ol>`;
  sortedA10.slice(0,3).forEach((x) => {
    rankingHtml += `<li>${x.sid} - ${x.pSave.toFixed(1)}%</li>`;
  });
  rankingHtml += `</ol>`;
  document.getElementById('ranking').innerHTML = rankingHtml;

  // B·∫£ng d·ªØ li·ªáu th√¥ (20 ng∆∞·ªùi m·ªõi nh·∫•t)
  // ƒê·∫£o ng∆∞·ª£c ƒë·ªÉ th·∫•y m·ªõi nh·∫•t tr∆∞·ªõc
  const latestData = rawData.slice().reverse().slice(0, 20);
  let tbl = `<b>Nh·∫≠t k√Ω n·ªôp b√†i (20 l∆∞·ª£t m·ªõi nh·∫•t):</b><table><tr><th>TG</th><th>L·ªõp</th><th>T√™n</th><th>Lo·∫°i</th><th>Chi ti·∫øt</th></tr>`;
  latestData.forEach(r => {
    const time = new Date(r.ts).toLocaleTimeString('vi-VN', {hour:'2-digit', minute:'2-digit'});
    let detail = '';
    if(r.khoi == 10) detail = `Ti·∫øt ki·ªám: ${((r.val4/r.val1)*100).toFixed(1)}%`;
    else detail = `G·ª≠i ${fmt(r.val1)}ƒë, l√£i ${r.val2}%`;
    
    tbl += `<tr>
      <td style="text-align:center">${time}</td>
      <td style="text-align:center">${r.khoi}</td>
      <td>${r.sid}</td>
      <td>${r.khoi==10?'Ng√¢n s√°ch':'L√£i k√©p'}</td>
      <td>${detail}</td>
    </tr>`;
  });
  tbl += '</table>';
  document.getElementById('teacher_table').innerHTML = tbl;
}

function drawPieChart(green, yellow, red) {
  const canvas = document.getElementById('pieChart');
  const ctx = canvas.getContext('2d');
  const total = green + yellow + red;
  if(total === 0) { ctx.clearRect(0,0,300,300); return; } // Ch∆∞a c√≥ data
  
  const data = [green, yellow, red];
  const colors = ['#15803d', '#f59e0b', '#dc2626'];
  let startAngle = 0;
  
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  data.forEach((value, i) => {
    const sliceAngle = (value / total) * 2 * Math.PI;
    ctx.beginPath();
    ctx.moveTo(150, 150);
    ctx.arc(150, 150, 140, startAngle, startAngle + sliceAngle);
    ctx.closePath();
    ctx.fillStyle = colors[i];
    ctx.fill();
    startAngle += sliceAngle;
  });
}
</script>
</body>
</html>